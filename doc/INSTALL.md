# Установка

## Debian 9.2

В первую очередь необходимы пакеты для клонирования репозитория и запуска php-скриптов. Установить их можно так: 

```
# apt-get install git php7.0-cli php7.0-mbstring php7.0-json php7.0-sqlite3
```

Склонируйте репозиторий в папку на сервере:

```
# git clone https://github.com/anton-pribora/jdi.git jdi
# cd jdi
```

По умолчанию задания будут выполняться от пользователя `www-data`. Убедитесь, что
пользователь имеет парава на запись в папку sys.  

```
# chown -R www-data:www-data sys/
```

Если нужно запускать задания под другим пользователем, то создайте конфиг `configs/20-local.php`,
в котором укажите пользователя и группу:

```php
<?php

Config()->setup([
    'owner' => [
        'user' => 'my-user',
        'group' => 'my-group',
    ],
]);
```

### База данных

По умолчанию jdi настроен на работу с базой данной SQLite, которая не требует дополнительных
установок и настроек. Однако, она не всегда правильно работает со множеством праллельных 
процессов, что может привести к ошибкам выполнения заданий. Поэтому по умолчанию количество 
выполняемых заданий выставлено 1.

Если вам нужно выполнять много заданий параллельно, то можно использовать базу данных MySQL.
Установить настройки можно командой:

```
# ./jdi.php db setup mysql -utest -ptest -hlocalhost just_do_it
```

Для установки настроек SQLite выполните (настроена по умолчанию):

```
# ./jdi.php db setup sqlite
```

После этого установите базу данных:

```
# ./jdi.php db reinstall
```

### Сервис

Чтобы задания выполнялись автоматически, установите системный сервис:

```
# ./jdi.php service install | sh
```

### Тестирование

Вы можете проетистровать работу сервиса добавив сто заданий следующей командой:

```
# hexdump -n100 -v -e '/1 "%02X\n"' /dev/zero | xargs -I% ./jdi.php add sleep 10
```

Для отмены заданий используйте:

```
# ./jdi.php list --remove
```

### Пример использования в Web-приложении

Для запуска примера можно воспользоваться встроенным в PHP веб-сервером. Выполните следующую
команду:

```
# php -S 127.0.0.1:3380 -t example/
```

После этого перейдите по ссылке `http://127.0.0.1:3380`.

## Удаление

Для удаления сервиса из системы выполните:

```
# ./jdi.php service remove | sh
```

Для удаления базы данных:

```
# ./jdi.php db remove
```